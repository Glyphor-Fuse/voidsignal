name: Auto-Fix

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  auto-fix:
    if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup GitHub CLI
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('GH_TOKEN', process.env.GITHUB_TOKEN);

      - name: Get workflow logs
        id: get-logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log > workflow_logs.txt 2>&1 || echo "Could not fetch logs"
          cat workflow_logs.txt | head -200

      - name: Detect and fix package-lock.json mismatch
        id: fix-lockfile
        run: |
          if grep -q "package.json and package-lock.json.*are in sync" workflow_logs.txt 2>/dev/null || \
             grep -q "Invalid: lock file" workflow_logs.txt 2>/dev/null; then
            echo "ðŸ”§ Detected package-lock.json mismatch, fixing..."
            npm install
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            if ! git diff --staged --quiet; then
              git commit -m "fix: update package-lock.json to match package.json [auto-fix]"
              git push
              echo "fixed=true" >> $GITHUB_OUTPUT
            else
              echo "fixed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect and fix Tailwind PostCSS plugin
        id: fix-tailwind
        run: |
          if grep -qi "tailwindcss.*PostCSS plugin" workflow_logs.txt 2>/dev/null || \
             grep -qi "PostCSS plugin has moved" workflow_logs.txt 2>/dev/null; then
            echo "ðŸ”§ Detected Tailwind PostCSS issue, fixing..."
            
            # Install @tailwindcss/postcss if not present
            if ! npm list @tailwindcss/postcss > /dev/null 2>&1; then
              npm install --save-dev @tailwindcss/postcss@4.1.18
            fi
            
            # Update postcss.config.js
            if [ -f postcss.config.js ]; then
              # Try different patterns to replace tailwindcss with @tailwindcss/postcss
              sed -i.bak "s/tailwindcss:/'@tailwindcss\/postcss':/g" postcss.config.js || true
              sed -i.bak "s/'tailwindcss':/'@tailwindcss\/postcss':/g" postcss.config.js || true
              sed -i.bak 's/"tailwindcss":/"@tailwindcss\/postcss":/g' postcss.config.js || true
              rm -f postcss.config.js.bak
            fi
            
            # Lock version in package.json if it has ^
            sed -i.bak 's/"@tailwindcss\/postcss": "\^[^"]*"/"@tailwindcss\/postcss": "4.1.18"/g' package.json || true
            rm -f package.json.bak
            
            npm install
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add postcss.config.js package.json package-lock.json
            if ! git diff --staged --quiet; then
              git commit -m "fix: use @tailwindcss/postcss for Tailwind CSS v4 [auto-fix]"
              git push
              echo "fixed=true" >> $GITHUB_OUTPUT
            else
              echo "fixed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.fix-lockfile.outputs.fixed == 'true' || steps.fix-tailwind.outputs.fixed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (prNumber) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ðŸ¤– **Auto-fix applied!**\n\nI detected and fixed the issue automatically. CI will re-run with the fix.'
              });
            }
